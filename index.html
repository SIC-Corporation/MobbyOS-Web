<body onload="brython({debug:0, cache:true})" class="flex h-screen w-screen overflow-hidden">

    <div id="boot-screen">
        <div class="boot-loader mb-6"></div>
        <div class="text-center">
            <p class="text-[11px] font-black uppercase tracking-[0.6em] text-sky-400">MobbyOS Core</p>
            <div id="boot-status" class="text-[8px] text-white/20 mt-2 uppercase tracking-widest italic">Initializing...</div>
        </div>
    </div>

    <script type="text/python">
        from browser import document, window, html, timer, ajax
        import json
        # Import your high-advanced encryption
        # Note: Ensure SICryption.py is in the same folder as index.html
        from SICryption import SICryption

        # Initialize SICryption with Roy's Master Key
        cipher = SICryption("SIC_CORP_ROY_2026")

        user_data = {"displayName": "User", "groqKey": "", "pfp": "https://i.imgur.com/r6oJp4O.png", "mode": "ADULT"}
        current_uid = None

        def refresh_ui():
            # If the groqKey is encrypted, we decrypt it just for the session
            display_key = user_data["groqKey"]
            if display_key.startswith("SIC|SECURED"):
                decrypted_key = cipher.decrypt(display_key)
                # We don't overwrite user_data["groqKey"] yet to keep the cloud version safe
            
            document["sideName"].text = user_data["displayName"]
            document["sidePFP"].src = user_data["pfp"]
            document["dashPFP"].src = user_data["pfp"]
            document["userRole"].text = f"{user_data['mode']} MODE ACTIVATED"
            
            status_text = document["mobbyStatus"]
            status_dot = document["statusDot"]
            
            if user_data["groqKey"]:
                status_text.text = "Neural Engine Online"
                status_text.style.color = "#38bdf8"
                status_dot.style.backgroundColor = "#22c55e"
            else:
                status_text.text = "Awaiting Key..."
                status_text.style.color = "#f8fafc4d"
                status_dot.style.backgroundColor = "#ef4444"
            
            welcome = document["welcomeMsg"]
            welcome.text = f"Hello, {user_data['displayName']}"
            welcome.classList.remove("run-anim")
            timer.set_timeout(lambda: welcome.classList.add("run-anim"), 10)

        # --- OPTIMIZED BOOT ---
        def hide_boot():
            document["boot-screen"].style.opacity = "0"
            timer.set_timeout(lambda: document["boot-screen"].classList.add("hidden"), 400)

        def on_auth(user):
            global current_uid
            document["boot-status"].text = "Authenticating..."
            
            if user:
                current_uid = user.uid
                # FAST BOOT: Hide the screen as soon as we know WHO the user is
                hide_boot()
                
                def load_data(snap):
                    if snap.exists():
                        data = snap.data().to_dict()
                        user_data.update(data)
                        refresh_ui()
                
                # Fetch data in the background
                window.getDoc(window.doc(window.db, "users", user.uid)).then(load_data)
            else:
                window.location.href = "login.html"

        # --- ADVANCED SYNC (WITH ENCRYPTION) ---
        def commit_changes(ev):
            document["commitBtn"].text = "SICRYPTING & SYNCING..."
            
            raw_key = document["cfgGroq"].value or user_data["groqKey"]
            
            # If the key isn't already encrypted, LOCK IT DOWN
            if raw_key and not raw_key.startswith("SIC|SECURED"):
                secure_key = cipher.encrypt(raw_key)
            else:
                secure_key = raw_key

            updates = {
                "displayName": document["cfgName"].value or user_data["displayName"],
                "groqKey": secure_key,
                "pfp": document["cfgPFPLink"].value or user_data["pfp"]
            }
            
            def success(res):
                user_data.update(updates)
                refresh_ui()
                document["configModal"].classList.add("hidden")
                document["commitBtn"].text = "Commit Cloud Sync"
                window.alert("SIC Corp: Data Encrypted & Saved.")

            window.updateDoc(window.doc(window.db, "users", current_uid), updates).then(success)

        # --- CHAT ENGINE (WITH DECRYPTION) ---
        def send_msg(ev=None):
            input_box = document["termInput"]
            text = input_box.value.strip()
            
            # Decrypt key on the fly for the API call
            actual_key = user_data["groqKey"]
            if actual_key.startswith("SIC|SECURED"):
                actual_key = cipher.decrypt(actual_key)

            if not text or not actual_key: return
            
            input_box.value = ""
            add_chat_ui(user_data["displayName"], text)
            
            def on_complete(req):
                if req.status == 200:
                    res = json.loads(req.text)
                    add_chat_ui("MobbyOS", res['choices'][0]['message']['content'])
                else:
                    add_chat_ui("System", "Neural Error.")

            ajax.post("https://api.groq.com/openai/v1/chat/completions",
                headers={"Authorization": f"Bearer {actual_key}", "Content-Type": "application/json"},
                data=json.dumps({
                    "model": "llama3-8b-8192",
                    "messages": [
                        {"role": "system", "content": f"You are MobbyOS. Created by Roy for SIC Corp."},
                        {"role": "user", "content": text}
                    ]
                }),
                oncomplete=on_complete)

        # ... Bindings remain the same ...
        document["btn-dash"].bind("click", change_view)
        document["btn-term"].bind("click", change_view)
        document["btn-config"].bind("click", toggle_config)
        document["commitBtn"].bind("click", commit_changes)
        document["sendBtn"].bind("click", send_msg)
        document["termInput"].bind("keydown", key_handler)

        window.auth.onAuthStateChanged(on_auth)
    </script>
