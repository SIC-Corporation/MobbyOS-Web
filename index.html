<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobbyOS Web V1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .mobby-gradient { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); }
        #chatBox { scroll-behavior: smooth; }
        
        /* TABLE STYLE FOR SIC CORP DATA */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; border: 1px solid rgba(79, 172, 254, 0.3); }
        th { background: rgba(79, 172, 254, 0.3); text-align: left; padding: 12px; border: 1px solid rgba(255,255,255,0.1); color: #4facfe; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px; border: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; color: #e2e8f0; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="keyModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
        <div class="glass max-w-sm w-full p-8 text-center border-cyan-500/30">
            <h2 class="text-xl font-bold mb-2 text-cyan-400">Neural Link Required</h2>
            <p class="text-gray-400 text-sm mb-6">Enter your Groq API Key. This is stored locally for SIC Corp security.</p>
            <input type="password" id="groqInput" placeholder="gsk_..." class="w-full bg-black/40 border border-white/10 p-3 rounded mb-4 outline-none focus:border-cyan-400 text-center text-white">
            <button onclick="window.saveKey()" class="w-full mobby-gradient p-3 rounded font-bold hover:opacity-90 transition text-black uppercase tracking-tighter">Initialize Brain</button>
        </div>
    </div>

    <div id="loginScreen" class="max-w-md mx-auto mt-20 p-8 glass text-center">
        <h1 class="text-3xl font-bold mb-2 mobby-gradient bg-clip-text text-transparent uppercase tracking-tighter">MobbyOS Web V1</h1>
        <p class="text-gray-500 mb-8 text-[10px] uppercase tracking-[0.3em]">SIC Corporation Secure Access</p>
        <input type="email" id="email" placeholder="Email" class="w-full bg-black/30 border border-white/10 p-3 rounded mb-4 outline-none focus:border-cyan-400">
        <input type="password" id="password" placeholder="Password" class="w-full bg-black/30 border border-white/10 p-3 rounded mb-6 outline-none focus:border-cyan-400">
        <button onclick="window.authEmail()" class="w-full mobby-gradient p-3 rounded font-bold mb-4 hover:opacity-90 transition text-black">LOGIN / SIGN UP</button>
        <div class="text-gray-600 mb-4 text-xs">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ OR ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
        <button onclick="window.authGoogle()" class="w-full bg-white text-black p-3 rounded font-bold hover:bg-gray-200 transition text-sm">CONTINUE WITH GOOGLE</button>
    </div>

    <div id="appScreen" class="hidden max-w-6xl mx-auto h-[85vh] flex gap-6">
        <div class="w-64 glass p-6 hidden md:flex flex-col border-r border-white/5">
            <h2 class="font-bold text-lg mb-10 mobby-gradient bg-clip-text text-transparent tracking-tighter">MOBBYOS V1</h2>
            <div class="flex-grow space-y-2 text-sm">
                <button class="w-full text-left p-3 bg-white/5 rounded-xl text-cyan-400 font-medium border border-cyan-500/20">üè† DASHBOARD</button>
                <button onclick="window.resetKey()" class="w-full text-left p-3 hover:bg-white/5 rounded-xl text-gray-400">üîë CHANGE API KEY</button>
            </div>
            <div class="pt-4 border-t border-white/5">
                <p class="text-[10px] text-gray-600 mb-4 uppercase">Owner: Roy | SIC Corp</p>
                <button onclick="window.logout()" class="text-red-400/60 hover:text-red-400 text-[10px] uppercase tracking-widest transition">Sign Out</button>
            </div>
        </div>

        <div class="flex-grow flex flex-col glass p-6 relative">
            <div id="chatBox" class="flex-grow overflow-y-auto space-y-4 mb-6 pr-2">
                <div class="bg-cyan-500/10 p-4 rounded-2xl border border-cyan-500/20 max-w-2xl">
                    <p class="text-cyan-400 text-[10px] font-black mb-1 uppercase tracking-widest">System Status</p>
                    <p class="text-sm text-gray-300">Neural links established. MobbyOS Web V1 is online. Welcome, Roy.</p>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <input type="text" id="userInput" placeholder="Command MobbyOS..." class="flex-grow bg-black/20 border border-white/10 p-4 rounded-2xl outline-none focus:border-cyan-400 transition-all text-white">
                <button id="sendBtn" class="mobby-gradient p-4 rounded-2xl font-bold shadow-lg shadow-cyan-500/20 hover:scale-105 active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="black"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAPgNEVr315jkYcww3MpjAOL93Dfgtl_k8",
            authDomain: "mobbyoswebapp.firebaseapp.com",
            projectId: "mobbyoswebapp",
            storageBucket: "mobbyoswebapp.firebasestorage.app",
            messagingSenderId: "6814948758",
            appId: "1:6814948758:web:a87a03eff182e0029091b7",
            measurementId: "G-BQJE3R5K2B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentHistory = [];

        window.saveKey = () => {
            const key = document.getElementById('groqInput').value.trim();
            if(key.startsWith('gsk_')) {
                localStorage.setItem('mobby_groq_key', key);
                document.getElementById('keyModal').classList.add('hidden');
            } else {
                alert("Format Error: Must start with gsk_");
            }
        };

        window.resetKey = () => {
            localStorage.removeItem('mobby_groq_key');
            document.getElementById('keyModal').classList.remove('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                if(!localStorage.getItem('mobby_groq_key')) {
                    document.getElementById('keyModal').classList.remove('hidden');
                }
                loadHistory(user.uid);
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        // FIXED GOOGLE AUTH
        window.authGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (err) {
                alert("Auth Error: " + err.message);
                console.error(err);
            }
        };

        // FIXED EMAIL AUTH
        window.authEmail = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Please fill in all fields.");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                try { 
                    await createUserWithEmailAndPassword(auth, email, pass); 
                } catch (err) { 
                    alert("Account Error: " + err.message); 
                }
            }
        };

        window.logout = () => signOut(auth);

        async function loadHistory(uid) {
            const docSnap = await getDoc(doc(db, "users", uid));
            if (docSnap.exists()) {
                currentHistory = docSnap.data().history;
                renderMessages();
            }
        }

        async function sendMessage() {
            const apiKey = localStorage.getItem('mobby_groq_key');
            if(!apiKey) { document.getElementById('keyModal').classList.remove('hidden'); return; }

            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            const systemPrompt = {
                role: "system",
                content: "You are MobbyOS Web V1. Your creator is Roy, the owner of SIC Corp. NexaFlow is an apart company of SIC Corp. SIC Corp owns all code. When Roy asks about structure, respond with a clean Markdown table."
            };

            if (currentHistory.length === 0 || currentHistory[0].role !== 'system') {
                currentHistory.unshift(systemPrompt);
            }

            currentHistory.push({ role: "user", content: text });
            input.value = '';
            renderMessages();

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: currentHistory })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;

                currentHistory.push({ role: "assistant", content: reply });
                renderMessages();
                await setDoc(doc(db, "users", auth.currentUser.uid), { history: currentHistory });
            } catch (err) {
                alert("Neural Link Error. Check API.");
            }
        }

        function renderMessages() {
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            currentHistory.forEach(msg => {
                if(msg.role === 'system') return;
                const isUser = msg.role === 'user';
                
                // Allow simple formatting for tables
                let formattedContent = msg.content.replace(/\n/g, '<br>');
                
                box.innerHTML += `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2">
                        <div class="${isUser ? 'bg-white/10 rounded-2xl rounded-tr-none' : 'bg-cyan-500/10 rounded-2xl rounded-tl-none border border-cyan-500/20'} p-4 max-w-[95%] overflow-x-auto">
                            <p class="text-[9px] font-black mb-1 tracking-widest ${isUser ? 'text-gray-500 text-right' : 'text-cyan-500'} uppercase">${isUser ? 'SIC_ADMIN' : 'MOBBY_CORE'}</p>
                            <div class="text-sm leading-relaxed text-gray-200">${msg.content}</div>
                        </div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('userInput').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
