<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobbyOS V1.1.0 | SIC Corp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --sky: #38bdf8; }
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* THE ANIMATION FIX */
        .typewriter { 
            display: inline-block;
            overflow: hidden; 
            white-space: nowrap; 
            border-right: 3px solid var(--sky); 
            width: 0; 
        }
        .run-anim { 
            animation: typing 1s steps(20, end) forwards, blink .75s step-end infinite; 
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink { from, to { border-color: transparent } 50% { border-color: var(--sky); } }

        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-btn { transition: 0.2s; border-left: 3px solid transparent; }
        .nav-active { background: rgba(56, 189, 248, 0.1); color: var(--sky); border-left: 3px solid var(--sky); }
    </style>
</head>
<body class="flex">

    <aside class="w-64 bg-black border-r border-white/5 flex flex-col p-6 z-50">
        <div class="mb-10 flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-sky-500/20 border border-sky-500/40 flex items-center justify-center font-black text-sky-400">M</div>
            <div>
                <p id="sideName" class="text-xs font-black uppercase tracking-tighter">System Offline</p>
                <p class="text-[8px] text-sky-400 font-bold opacity-50 uppercase">V1.1.0 STABLE</p>
            </div>
        </div>
        <nav class="space-y-1 flex-grow">
            <button onclick="changeView('dashboard')" id="btn-dash" class="nav-btn w-full text-left p-3 rounded-lg text-[10px] font-black uppercase text-white/40 hover:text-white">Dashboard</button>
            <button onclick="checkTerminal()" id="btn-term" class="nav-btn w-full text-left p-3 rounded-lg text-[10px] font-black uppercase text-white/40 hover:text-white">Terminal</button>
            <button onclick="toggleModal('settingsModal')" class="nav-btn w-full text-left p-3 rounded-lg text-[10px] font-black uppercase text-white/40 hover:text-white">Config</button>
            <button onclick="toggleModal('historyModal')" class="nav-btn w-full text-left p-3 rounded-lg text-[10px] font-black uppercase text-white/40 hover:text-white">History</button>
        </nav>
    </aside>

    <main class="flex-grow relative">
        <div id="view-dashboard" class="absolute inset-0 flex flex-col justify-center p-20">
            <h1 class="text-[10px] font-black text-sky-400 tracking-[0.5em] mb-4">SYSTEM READY</h1>
            <div class="h-24">
                <span id="welcomeMsg" class="text-6xl font-black text-white typewriter">Welcome</span>
            </div>
        </div>

        <div id="view-terminal" class="absolute inset-0 flex flex-col p-10 hidden bg-[#020617]">
            <div id="chatBox" class="flex-grow overflow-y-auto glass rounded-3xl p-6 mb-4 font-mono text-xs space-y-4"></div>
            <div class="glass p-4 rounded-2xl flex gap-4">
                <input id="termInput" class="bg-transparent flex-grow outline-none text-sm" placeholder="Execute command...">
                <button onclick="sendMessage()" class="text-sky-400 font-black text-xs uppercase">Run</button>
            </div>
        </div>
    </main>

    <div id="groqAlert" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center hidden">
        <div class="p-10 glass rounded-[2rem] text-center max-w-xs">
            <div class="text-3xl mb-4">⚠️</div>
            <h2 class="font-black uppercase text-sm mb-2">Neural Link Offline</h2>
            <p class="text-[10px] text-white/40 mb-6">You must initialize your Groq API Key in Config to use the Terminal.</p>
            <button onclick="toggleModal('groqAlert')" class="w-full bg-sky-500 p-3 rounded-xl font-black text-[10px] uppercase">Acknowledge</button>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center hidden">
        <div class="p-10 glass rounded-[3rem] w-full max-w-sm">
            <h2 class="font-black uppercase text-sky-400 text-xs mb-6">System Config</h2>
            <div class="space-y-4">
                <input id="newName" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-sm outline-none" placeholder="New Display Name">
                <input id="newGroq" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-sm outline-none" type="password" placeholder="Groq API Key">
                <button onclick="saveChanges()" class="w-full bg-white text-black p-4 rounded-xl font-black text-[10px] uppercase">Commit Changes</button>
                <button onclick="toggleModal('settingsModal')" class="w-full text-white/20 font-black text-[9px] uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAPgNEVr315jkYcww3MpjAOL93Dfgtl_k8", authDomain: "mobbyoswebapp.firebaseapp.com", projectId: "mobbyoswebapp", storageBucket: "mobbyoswebapp.firebasestorage.app", messagingSenderId: "6814948758", appId: "1:6814948758:web:a87a03eff182e0029091b7" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let uData = { displayName: "User", groqKey: "" };

        onAuthStateChanged(auth, async (user) => {
            if (!user) return window.location.href = "login.html";
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()) uData = snap.data();
            
            // FORCE START UI
            document.getElementById('sideName').innerText = uData.displayName;
            changeView('dashboard');
        });

        // FIXED NAVIGATION & ANIMATION TRIGGER
        window.changeView = (target) => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-terminal').classList.add('hidden');
            document.getElementById('btn-dash').classList.remove('nav-active');
            document.getElementById('btn-term').classList.remove('nav-active');

            document.getElementById(`view-${target}`).classList.remove('hidden');
            document.getElementById(`btn-${target === 'dashboard' ? 'dash' : 'term'}`).classList.add('nav-active');

            if(target === 'dashboard') {
                const welcome = document.getElementById('welcomeMsg');
                welcome.innerText = `Welcome, ${uData.displayName}`;
                welcome.classList.remove('run-anim');
                void welcome.offsetWidth; // TRICK TO RESTART ANIMATION
                welcome.classList.add('run-anim');
            }
        };

        window.checkTerminal = () => {
            if(!uData.groqKey) {
                toggleModal('groqAlert');
            } else {
                changeView('terminal');
            }
        };

        window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');

        window.saveChanges = async () => {
            const name = document.getElementById('newName').value.trim();
            const groq = document.getElementById('newGroq').value.trim();
            const updates = {};
            if(name) updates.displayName = name;
            if(groq) updates.groqKey = groq;

            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            uData = {...uData, ...updates};
            document.getElementById('sideName').innerText = uData.displayName;
            toggleModal('settingsModal');
            alert("System Synced.");
            changeView('dashboard');
        };

        window.sendMessage = async () => {
            const input = document.getElementById('termInput');
            const chat = document.getElementById('chatBox');
            if(!input.value) return;
            
            const msg = input.value;
            input.value = '';
            chat.innerHTML += `<div class="text-white/40 uppercase font-black text-[9px]">User</div><div class="mb-4">${msg}</div>`;
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${uData.groqKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama3-8b-8192", messages: [{role: "user", content: msg}] })
                });
                const data = await res.json();
                chat.innerHTML += `<div class="text-sky-400 uppercase font-black text-[9px]">MobbyOS</div><div class="mb-4 text-sky-100">${data.choices[0].message.content}</div>`;
            } catch {
                chat.innerHTML += `<div class="text-red-500 font-bold uppercase">Engine Error</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
        };
    </script>
</body>
</html>
