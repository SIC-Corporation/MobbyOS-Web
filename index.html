<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobbyOS | SIC Corp Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00f2fe; --bg: #050507; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* ADULT MODE UI - SHARP & DARK */
        .mode-adult { --accent: #ff0055; font-family: 'JetBrains Mono', monospace; }
        .mode-adult .glass-panel { background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.05); border-radius: 0; }
        .mode-adult .mobby-gradient { background: #ff0055; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* KID MODE UI - SOFT & BRIGHT */
        .mode-kid { --accent: #00f2fe; }
        .mode-kid .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; }

        .glass-panel { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-item { transition: 0.2s; border-left: 3px solid transparent; }
        .sidebar-item.active { background: rgba(255,255,255,0.05); border-left-color: var(--accent); color: white; }
        
        #chatBox::-webkit-scrollbar { width: 4px; }
        #chatBox::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        
        /* Terminal scanline effect for Adult mode */
        .mode-adult::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 99; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
    </style>
</head>
<body id="mainBody" class="mode-kid flex p-4 gap-4">

    <div id="settingsModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass-panel max-w-sm w-full p-8">
            <h2 class="text-xl font-black mb-6 tracking-tighter uppercase">System Config</h2>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block mb-2">Operating Mode</label>
                    <select id="modeSelect" onchange="updateMode()" class="w-full bg-white/5 border border-white/10 p-3 rounded text-sm outline-none">
                        <option value="kid">Standard (Kid Mode)</option>
                        <option value="adult">SIC Admin (Adult Mode)</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest block mb-2">Groq Key</label>
                    <input type="password" id="groqInput" placeholder="gsk_..." class="w-full bg-white/5 border border-white/10 p-3 rounded text-sm">
                </div>
                <button onclick="saveSettings()" class="w-full bg-white text-black py-3 font-bold text-xs tracking-widest uppercase hover:bg-cyan-400 transition">Execute Save</button>
                <button onclick="toggleSettings()" class="w-full text-gray-500 text-[10px] uppercase font-bold tracking-widest">Close Terminal</button>
            </div>
        </div>
    </div>

    <aside class="w-72 glass-panel flex flex-col p-6 hidden lg:flex">
        <div class="mb-10">
            <h1 class="text-2xl font-black tracking-tighter mobby-gradient">MOBBYOS</h1>
            <p id="modeStatus" class="text-[9px] text-gray-600 font-bold tracking-[0.3em] uppercase">Status: Friendly</p>
        </div>
        <button onclick="createNewChat()" class="border border-white/10 p-4 text-[10px] font-bold tracking-widest hover:bg-white/5 transition mb-6">NEW THREAD</button>
        <nav id="chatHistoryList" class="flex-grow space-y-1 overflow-y-auto"></nav>
        <div class="mt-auto border-t border-white/5 pt-4">
            <button onclick="toggleSettings()" class="text-gray-500 hover:text-white text-[10px] font-bold tracking-widest uppercase">System Config</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col glass-panel overflow-hidden relative">
        <div id="loginScreen" class="absolute inset-0 z-50 bg-[#050507] flex items-center justify-center">
            <div class="w-64 text-center">
                <h2 class="text-2xl font-black tracking-tighter mb-8">AUTHENTICATE</h2>
                <input type="email" id="email" placeholder="ID" class="w-full bg-white/5 border-b border-white/10 p-3 mb-4 outline-none text-center">
                <input type="password" id="password" placeholder="KEY" class="w-full bg-white/5 border-b border-white/10 p-3 mb-8 outline-none text-center">
                <button onclick="authEmail()" class="w-full border border-white/20 py-3 text-[10px] font-bold tracking-widest hover:bg-white hover:text-black transition">INITIALIZE</button>
            </div>
        </div>

        <div id="chatBox" class="flex-grow overflow-y-auto p-8 space-y-8"></div>

        <footer class="p-6 border-t border-white/5">
            <div class="max-w-4xl mx-auto flex gap-4">
                <input type="text" id="userInput" placeholder="Enter Command..." class="flex-grow bg-transparent border-b border-white/10 py-3 outline-none text-sm focus:border-white transition-all">
                <button id="sendBtn" class="text-white hover:text-cyan-400 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                </button>
            </div>
        </footer>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAPgNEVr315jkYcww3MpjAOL93Dfgtl_k8", authDomain: "mobbyoswebapp.firebaseapp.com", projectId: "mobbyoswebapp", storageBucket: "mobbyoswebapp.firebasestorage.app", messagingSenderId: "6814948758", appId: "1:6814948758:web:a87a03eff182e0029091b7" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentChatId = null;
        let chats = {};
        let currentMode = 'kid';

        window.toggleSettings = () => document.getElementById('settingsModal').classList.toggle('hidden');
        
        window.updateMode = () => {
            currentMode = document.getElementById('modeSelect').value;
            const body = document.getElementById('mainBody');
            const status = document.getElementById('modeStatus');
            
            if(currentMode === 'adult') {
                body.className = 'mode-adult flex p-4 gap-4';
                status.innerText = 'Status: Unrestricted';
                status.style.color = '#ff0055';
            } else {
                body.className = 'mode-kid flex p-4 gap-4';
                status.innerText = 'Status: Friendly';
                status.style.color = '#00f2fe';
            }
        };

        window.saveSettings = () => {
            localStorage.setItem('mobby_mode', currentMode);
            const key = document.getElementById('groqInput').value.trim();
            if(key) localStorage.setItem('mobby_groq_key', key);
            toggleSettings();
            renderMessages(); // Refresh UI
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                currentMode = localStorage.getItem('mobby_mode') || 'kid';
                document.getElementById('modeSelect').value = currentMode;
                updateMode();
                loadUserChats();
            }
        });

        window.authEmail = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch { await createUserWithEmailAndPassword(auth, email, pass); }
        };

        async function loadUserChats() {
            const q = query(collection(db, "users", auth.currentUser.uid, "threads"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            document.getElementById('chatHistoryList').innerHTML = '';
            querySnapshot.forEach((doc) => {
                chats[doc.id] = doc.data().history;
                createChatTab(doc.id, doc.data().title);
            });
            if(querySnapshot.empty) createNewChat();
            else switchChat(querySnapshot.docs[0].id);
        }

        window.createNewChat = () => {
            const id = 'thread_' + Date.now();
            chats[id] = [];
            currentChatId = id;
            createChatTab(id, "New Thread");
            switchChat(id);
        };

        function createChatTab(id, title) {
            const div = document.createElement('div');
            div.id = `tab-${id}`;
            div.className = "sidebar-item p-3 text-[10px] font-bold tracking-widest text-gray-500 cursor-pointer uppercase truncate";
            div.innerText = title || "Neural Thread";
            div.onclick = () => switchChat(id);
            document.getElementById('chatHistoryList').prepend(div);
        }

        function switchChat(id) {
            currentChatId = id;
            document.querySelectorAll('.sidebar-item').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`)?.classList.add('active');
            renderMessages();
        }

        async function sendMessage() {
            const apiKey = localStorage.getItem('mobby_groq_key');
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text || !apiKey) return;

            const systemContent = currentMode === 'adult' 
                ? "You are MobbyOS Adult Mode. You are professional, sharp, and use mature, cynical language. You can be insulting if the user is being slow. You belong to SIC Corp, owned by Roy. Use professional technical jargon."
                : "You are MobbyOS Kid Mode. Use very friendly, simple, and explanatory words. Be helpful and encouraging. You belong to SIC Corp, owned by Roy.";

            if (chats[currentChatId].length === 0) {
                chats[currentChatId].push({ role: "system", content: systemContent });
                document.getElementById(`tab-${currentChatId}`).innerText = text.substring(0, 15);
            }

            chats[currentChatId].push({ role: "user", content: text });
            input.value = '';
            renderMessages();

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: chats[currentChatId] })
                });
                const data = await res.json();
                chats[currentChatId].push({ role: "assistant", content: data.choices[0].message.content });
                renderMessages();
                await setDoc(doc(db, "users", auth.currentUser.uid, "threads", currentChatId), {
                    history: chats[currentChatId],
                    title: chats[currentChatId][1].content.substring(0, 20),
                    timestamp: Date.now()
                });
            } catch (err) { console.error(err); }
        }

        function renderMessages() {
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            (chats[currentChatId] || []).forEach(msg => {
                if(msg.role === 'system') return;
                const isUser = msg.role === 'user';
                box.innerHTML += `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] ${isUser ? 'text-right' : 'text-left'}">
                            <p class="text-[8px] font-bold tracking-[0.3em] mb-2 opacity-40 uppercase">${isUser ? 'SIC_ADMIN' : 'MOBBY_CORE'}</p>
                            <div class="text-sm leading-relaxed">${msg.content}</div>
                        </div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('userInput').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
